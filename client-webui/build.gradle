version = '0.0.10'

task clean(type: Delete) {
    delete file('build')
}

task build(type: Zip) {
    Map ENVIRONMENT_MODULES_HOSTS = [ 'local': 'http://localhost:8080', 'shared': 'http://diplodoc-test.whelastic.net' ]

    from '.'

    exclude 'build'
    exclude 'build.gradle'
    exclude 'client-webui.iml'

    destinationDir = file('build/libs')
    baseName = "${project.name}-${project.version}"

    doFirst {
        files({ file('src').listFiles() }).findAll({ it.name.endsWith 'js' }).each({ it.text = it.text.replace '${modules_host}', ENVIRONMENT_MODULES_HOSTS[targetEnv] })
        files({ file('.').listFiles() }).findAll({ it.name.endsWith 'html' }).each({ it.text = it.text.replace '${modules_host}', ENVIRONMENT_MODULES_HOSTS[targetEnv] })
    }

    doLast {
        files({ file('src').listFiles() }).findAll({ it.name.endsWith 'js' }).each({ it.text = it.text.replace ENVIRONMENT_MODULES_HOSTS[targetEnv], '${modules_host}' })
        files({ file('.').listFiles() }).findAll({ it.name.endsWith 'html' }).each({ it.text = it.text.replace ENVIRONMENT_MODULES_HOSTS[targetEnv], '${modules_host}' })
    }
}